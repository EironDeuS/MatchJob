{% extends 'gestionOfertas/base.html' %}
{% load static %}

{% block title %}Postulantes - {{ oferta.nombre }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/postulantes_oferta.css' %}">
{% endblock %}


{% block content %}
<div class="container my-5">
<h2 class="mb-4">
    <i class="bi bi-people-fill me-2"></i> Postulantes para: <strong>{{ oferta.nombre }}</strong>
</h2>

{% if postulaciones %}
<div class="table-responsive">
    <table class="table table-hover">
    <thead class="table-light">
        <tr>
            <th><i class="bi bi-person-fill text-muted"></i> Postulante</th>
            <th><i class="bi bi-calendar-date text-muted"></i> Fecha</th>
            <th><i class="bi bi-tag text-muted"></i> Estado</th>
            <th><i class="bi bi-gear-fill text-muted"></i> Acciones</th>
            <th><i class="bi bi-arrow-left-right text-muted"></i> Cambiar Estado</th>
            <th><i class="bi bi-lightbulb text-muted"></i> Match</th>
        </tr>
    </thead>
    <tbody>
        {% for postulacion in postulaciones %}
        <tr>
        <td>
            <div class="d-flex align-items-center">
            {% if postulacion.persona.foto_perfil %}
                <img src="{{ postulacion.persona.foto_perfil.url }}" class="rounded-circle me-2" width="30" height="30" alt="Foto postulante">
            {% else %}
                <i class="bi bi-person-circle me-2 fs-4 text-muted"></i>
            {% endif %}
            {{ postulacion.persona.nombre_completo }}
            </div>
        </td>
        <td>
            <small class="text-muted">
            <i class="bi bi-clock-fill text-secondary me-1"></i>
            {{ postulacion.fecha_postulacion|date:"d/m/Y" }}
            </small>
        </td>
        <td>
            <span class="badge bg-{% if postulacion.estado == 'pendiente' %}warning text-dark{% elif postulacion.estado == 'filtrado' %}primary{% elif postulacion.estado == 'match' %}info{% elif postulacion.estado == 'contratado' %}success{% elif postulacion.estado == 'rechazado' %}danger{% elif postulacion.estado == 'finalizado' %}secondary{% endif %}">
            {{ postulacion.get_estado_display }}
            </span>
        </td>
        <td>
            <a href="{% url 'ver_perfil_publico' postulacion.persona.usuario.id %}" target="_blank" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye me-1"></i> Ver Perfil
            </a>
            </td>
            <td>
            <form method="post" action="{% url 'cambiar_estado_postulacion' postulacion.id %}?next={% url 'postulantes_por_oferta' oferta.id %}">
                {% csrf_token %}
                <select name="nuevo_estado" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="" disabled selected>Selecciona estado...</option>
                <option value="pendiente" {% if postulacion.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="filtrado" {% if postulacion.estado == 'filtrado' %}selected{% endif %}>Filtrado</option>
                <option value="match" {% if postulacion.estado == 'match' %}selected{% endif %}>Match</option>
                <option value="contratado" {% if postulacion.estado == 'contratado' %}selected{% endif %}>Contratado</option>
                <option value="rechazado" {% if postulacion.estado == 'rechazado' %}selected{% endif %}>Rechazado</option>
                <option value="finalizado" {% if postulacion.estado == 'finalizado' %}selected{% endif %}>Finalizado</option>
                </select>
            </form>
            </td>
            <td>
                <a href="#"
                class="btn btn-sm btn-outline-success"
                data-bs-toggle="modal"
                data-bs-target="#modalConfirmarMatch"
                data-nombre="{{ postulacion.persona.nombre_completo }}"
                data-telefono="{{ postulacion.persona.usuario.telefono }}"
                data-id="{{ postulacion.id }}"
                data-oferta="{{ oferta.nombre|default:"Sin descripción"|truncatewords:5 }}">
                    <i class="bi bi-whatsapp"></i> Match
                </a>
            </td>

        </tr>
        {% endfor %}
    </tbody>
    </table>
    </div>
    {% else %}
    <div class="alert alert-info text-center">
    <i class="bi bi-info-circle-fill me-2"></i> No hay postulantes para esta oferta.
    </div>
    {% endif %}

    <div class="mt-4">
    <a href="{% url 'mis_ofertas' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i> Volver a Mis Ofertas
    </a>
    </div>
</div>

<div class="modal fade" id="modalConfirmarMatch" tabindex="-1" aria-labelledby="modalConfirmarMatchLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white rounded-top-4">
                <h5 class="modal-title" id="modalConfirmarMatchLabel">
                    <i class="bi bi-check2-circle me-2"></i> Confirmar Match
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-person-check text-primary" style="font-size: 3rem;"></i>

                <p class="mt-3 fs-5">¿Deseas hacer <strong>match</strong> con <span id="matchNombre" class="text-primary fw-bold"></span> y contactarlo vía <i class="bi bi-whatsapp text-success"></i> WhatsApp?</p>
            </div>
            <div class="modal-footer justify-content-center border-0 pb-4">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Cancelar
                </button>
                <a id="btnWhatsapp" href="#" target="_blank" class="btn btn-success px-4">
                    <i class="bi bi-whatsapp me-1"></i> Contactar
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var modal = document.getElementById('modalConfirmarMatch');
        modal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var nombre = button.getAttribute('data-nombre');
            var telefono = button.getAttribute('data-telefono');
            var postulacionId = button.getAttribute('data-id');
            var tituloOferta = button.getAttribute('data-oferta');

            var nombreSpan = modal.querySelector('#matchNombre');
            var whatsappBtn = modal.querySelector('#btnWhatsapp');

            nombreSpan.textContent = nombre;

            var telefonoConPrefijo = telefono.startsWith('+') ? telefono : `+56${telefono}`;
            var mensaje = `Hola ${nombre}, hemos hecho match contigo en MatchJob respecto a tu postulación #${postulacionId} para la oferta "${tituloOferta}". Nos gustaría contactarte para conversar más sobre esta oportunidad.`;

            whatsappBtn.href = `https://wa.me/${telefonoConPrefijo.replace(/\D/g, '')}?text=${encodeURIComponent(mensaje)}`;
        });
    });
    </script>

{% endblock %}




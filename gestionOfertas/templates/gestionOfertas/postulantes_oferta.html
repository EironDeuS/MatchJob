{% extends 'gestionOfertas/base.html' %}
{% load static %}

{% block title %}Postulantes - {{ oferta.nombre }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/postulantes_oferta.css' %}">
    
{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4">
        <i class="bi bi-people-fill me-2"></i> Postulantes para: <strong>{{ oferta.nombre }}</strong>
    </h2>

    {% if postulaciones %}
    <div class="table-responsive">
        <table class="table table-hover align-middle"> {# Added align-middle for better vertical alignment #}
        <thead class="table-light">
            <tr>
                <th><i class="bi bi-person-fill text-muted"></i> Postulante</th>
                <th><i class="bi bi-calendar-date text-muted"></i> Fecha</th>
                <th><i class="bi bi-tag text-muted"></i> Estado</th>
                <th><i class="bi bi-robot text-muted"></i> Estado IA</th> {# NUEVA COLUMNA #}
                <th><i class="bi bi-star-fill text-muted"></i> Puntaje IA</th> {# NUEVA COLUMNA #}
                <th><i class="bi bi-gear-fill text-muted"></i> Acciones</th> {# COLUMNA CONSOLIDADA #}
            </tr>
        </thead>
        <tbody>
            {% for postulacion in postulaciones %}
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                    {% if postulacion.persona.foto_perfil %}
                        <img src="{{ postulacion.persona.foto_perfil.url }}" class="rounded-circle me-2" width="30" height="30" alt="Foto postulante">
                    {% else %}
                        <i class="bi bi-person-circle me-2 fs-4 text-muted"></i>
                    {% endif %}
                    {{ postulacion.persona.nombre_completo }}
                    </div>
                </td>
                <td>
                    <small class="text-muted">
                    <i class="bi bi-clock-fill text-secondary me-1"></i>
                    {{ postulacion.fecha_postulacion|date:"d/m/Y" }}
                    </small>
                </td>
                <td>
                    {# Actualización del badge para 'estado' sin 'filtrado' #}
                    <span class="badge bg-{% if postulacion.estado == 'pendiente' %}warning text-dark{% elif postulacion.estado == 'match' %}info{% elif postulacion.estado == 'contratado' %}success{% elif postulacion.estado == 'rechazado' %}danger{% elif postulacion.estado == 'finalizado' %}secondary{% else %}primary{% endif %}">
                    {{ postulacion.get_estado_display }}
                    </span>
                </td>
                {# NUEVA COLUMNA: Estado IA #}
                <td>
                    <span class="badge bg-{% if postulacion.estado_ia_analisis == 'aprobado_ia' %}success{% elif postulacion.estado_ia_analisis == 'rechazado_ia' %}danger{% elif postulacion.estado_ia_analisis == 'en_analisis' %}info{% elif postulacion.estado_ia_analisis == 'pendiente_ia' %}warning text-dark{% elif postulacion.estado_ia_analisis == 'error_analisis' %}secondary{% endif %}">
                        {{ postulacion.get_estado_ia_analisis_display }}
                    </span>
                </td>
                {# NUEVA COLUMNA: Puntaje IA con Tooltip #}
                <td>
                    {% if postulacion.puntaje_ia is not None %}
                        {{ postulacion.puntaje_ia }}
                        <i class="bi bi-question-circle ms-1 text-info"
                           data-bs-toggle="tooltip" data-bs-placement="top"
                           data-bs-html="true"
                           title="{% if postulacion.razones_ia %}
                                <strong>Fortalezas:</strong> {{ postulacion.razones_ia.fortalezas|default:"No especificado."|safe }}<br>
                                <strong>Oportunidades de Mejora:</strong> {{ postulacion.razones_ia.oportunidades_mejora|default:"No especificado."|safe }}<br>
                                <strong>Resumen:</strong> {{ postulacion.razones_ia.resumen_coincidencia|default:"No especificado."|safe }}
                            {% else %}
                                No hay razones disponibles.
                            {% endif %}">
                        </i>
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                {# COLUMNA CONSOLIDADA: Acciones - SOLUCIONADO #}
                <td>
                    {# Botón Ver Perfil - SOLUCIONADO #}
                    <a href="{% url 'ver_perfil_publico' postulacion.persona.usuario.id %}" 
                       target="_blank" 
                       class="btn btn-sm btn-outline-primary me-1 btn-ver-perfil"
                       onclick="event.stopPropagation();"
                       rel="noopener noreferrer">
                        <i class="bi bi-eye me-1"></i> Ver Perfil
                    </a>
                    
                    {# Botón de eliminar #}
                    <button type="button"
                            class="btn btn-sm btn-outline-danger me-1"
                            data-bs-toggle="modal"
                            data-bs-target="#modalConfirmarEliminar"
                            data-postulacion-id="{{ postulacion.id }}"
                            data-postulante-nombre="{{ postulacion.persona.nombre_completo }}"
                            onclick="event.stopPropagation();">
                        <i class="bi bi-trash me-1"></i> Eliminar
                    </button>
                    
                    {# Botón de Match #}
                    <a href="#"
                       class="btn btn-sm btn-success"
                       data-bs-toggle="modal"
                       data-bs-target="#modalConfirmarMatch"
                       data-nombre="{{ postulacion.persona.nombre_completo }}"
                       data-telefono="{{ postulacion.persona.usuario.telefono }}"
                       data-id="{{ postulacion.id }}"
                       data-oferta="{{ oferta.nombre|default:"Sin descripción"|truncatewords:5 }}"
                       onclick="event.stopPropagation();">
                        <i class="bi bi-whatsapp"></i> Match
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
    {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle-fill me-2"></i> No hay postulantes para esta oferta.
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'mis_ofertas' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-1"></i> Volver a Mis Ofertas
        </a>
    </div>

    {# MODAL EXISTENTE para Match #}
    <div class="modal fade" id="modalConfirmarMatch" tabindex="-1" aria-labelledby="modalConfirmarMatchLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-primary text-white rounded-top-4">
                    <h5 class="modal-title" id="modalConfirmarMatchLabel">
                        <i class="bi bi-check2-circle me-2"></i> Confirmar Match
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-person-check text-primary" style="font-size: 3rem;"></i>

                    <p class="mt-3 fs-5">¿Deseas hacer <strong>match</strong> con <span id="matchNombre" class="text-primary fw-bold"></span> y contactarlo vía <i class="bi bi-whatsapp text-success"></i> WhatsApp?</p>
                </div>
                <div class="modal-footer justify-content-center border-0 pb-4">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </button>
                    <a id="btnWhatsapp" href="#" target="_blank" class="btn btn-success px-4">
                        <i class="bi bi-whatsapp me-1"></i> Contactar
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# NUEVO MODAL para Eliminar Postulante #}
    <div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalConfirmarEliminarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header bg-danger text-white rounded-top-4">
                    <h5 class="modal-title" id="modalConfirmarEliminarLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-trash text-danger" style="font-size: 3rem;"></i>
                    <p class="mt-3 fs-5">¿Estás seguro de que quieres eliminar la postulación de <strong id="eliminarPostulanteNombre"></strong>?</p>
                    <p class="text-muted">Esta acción es irreversible y eliminará todos los datos relacionados con esta postulación.</p>
                </div>
                <div class="modal-footer justify-content-center border-0 pb-4">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </button>
                    {# Formulario para enviar la solicitud de eliminación #}
                    <form id="formEliminarPostulacion" method="post" action="">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger px-4">
                            <i class="bi bi-trash-fill me-1"></i> Eliminar Postulación
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Lógica del Modal de Match (ya existía) ---
        var matchModal = document.getElementById('modalConfirmarMatch');
        matchModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var nombre = button.getAttribute('data-nombre');
            var telefono = button.getAttribute('data-telefono');
            var postulacionId = button.getAttribute('data-id');
            var tituloOferta = button.getAttribute('data-oferta');

            var nombreSpan = matchModal.querySelector('#matchNombre');
            var whatsappBtn = matchModal.querySelector('#btnWhatsapp');

            nombreSpan.textContent = nombre;

            var telefonoConPrefijo = telefono.startsWith('+') ? telefono : `+56${telefono}`;
            var mensaje = `Hola ${nombre}, hemos hecho match contigo en MatchJob respecto a tu postulación #${postulacionId} para la oferta "${tituloOferta}". Nos gustaría contactarte para conversar más sobre esta oportunidad.`;

            whatsappBtn.href = `https://wa.me/${telefonoConPrefijo.replace(/\D/g, '')}?text=${encodeURIComponent(mensaje)}`;
        });

        // --- Lógica del Nuevo Modal para Eliminar Postulante ---
        var eliminarModal = document.getElementById('modalConfirmarEliminar');
        eliminarModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var postulacionId = button.getAttribute('data-postulacion-id');
            var postulanteNombre = button.getAttribute('data-postulante-nombre');

            var nombreSpan = eliminarModal.querySelector('#eliminarPostulanteNombre');
            var form = eliminarModal.querySelector('#formEliminarPostulacion');

            nombreSpan.textContent = postulanteNombre;
            form.action = `/postulaciones/${postulacionId}/eliminar/`;
        });

        // --- SOLUCIÓN MEJORADA: Manejo robusto de botones Ver Perfil ---
        document.querySelectorAll('.btn-ver-perfil').forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const url = this.getAttribute('href');
                
                // Verificar que la URL es válida
                if (url && url !== '#') {
                    window.open(url, '_blank', 'noopener,noreferrer');
                } else {
                    console.error('URL inválida para Ver Perfil');
                }
            });
        });

        // --- Inicializar todos los Bootstrap Tooltips ---
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    </script>
{% endblock %}
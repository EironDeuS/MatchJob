{% extends 'gestionOfertas/base.html' %}

{% load static %}

{% block title %}Registro - MatchJob{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="text-center mb-4">Crear una cuenta</h2>

          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}

          {% if form.non_field_errors %}
              <div class="alert alert-danger">
                  {% for error in form.non_field_errors %}
                      <p>{{ error }}</p>
                  {% endfor %}
              </div>
          {% endif %}

          <form method="post" novalidate> {# Añadido novalidate para que los errores de Django se muestren bien #}
            {% csrf_token %}

            {# --- Tipo de Usuario --- #}
            <div class="mb-3">
              <label for="{{ form.tipo_usuario.id_for_label }}" class="form-label">{{ form.tipo_usuario.label }}</label>
              {{ form.tipo_usuario.errors }}
              {{ form.tipo_usuario }}
            </div>

            {# --- Campos Persona Natural (Ocultos por defecto) --- #}
            <div id="persona-fields" style="display:none;">
              <div class="mb-3">
                <label for="{{ form.nombres.id_for_label }}" class="form-label">{{ form.nombres.label }}</label>
                 {{ form.nombres.errors }}
                {{ form.nombres }}
              </div>
              <div class="mb-3">
                <label for="{{ form.apellidos.id_for_label }}" class="form-label">{{ form.apellidos.label }}</label>
                 {{ form.apellidos.errors }}
                {{ form.apellidos }}
              </div>
              <div class="mb-3">
                <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">{{ form.fecha_nacimiento.label }}</label>
                 {{ form.fecha_nacimiento.errors }}
                {{ form.fecha_nacimiento }}
              </div>
              <div class="mb-3">
                <label for="{{ form.nacionalidad.id_for_label }}" class="form-label">{{ form.nacionalidad.label }}</label>
                 {{ form.nacionalidad.errors }}
                {{ form.nacionalidad }}
              </div>
            </div>

            {# --- Campos Empresa (Ocultos por defecto) --- #}
            <div id="empresa-fields" style="display:none;">
              <div class="mb-3">
                <label for="{{ form.nombre_empresa.id_for_label }}" class="form-label">{{ form.nombre_empresa.label }}</label>
                 {{ form.nombre_empresa.errors }}
                {{ form.nombre_empresa }}
              </div>
              {# --- Campo razon_social eliminado --- #}
              <div class="mb-3">
                <label for="{{ form.razon_social.id_for_label }}" class="form-label">{{ form.razon_social.label }}</label>
                 {{ form.razon_social.errors }}
                {{ form.razon_social }}
              </div>
              <div class="mb-3">
                <label for="{{ form.giro.id_for_label }}" class="form-label">{{ form.giro.label }}</label>
                 {{ form.giro.errors }}
                {{ form.giro }}
              </div>
               {# Añadir aquí otros campos de empresa si los pusiste en el form #}
            </div>

            {# --- Campos Comunes (Usuario) --- #}
            <hr>
            <div class="mb-3">
              <label for="{{ form.username.id_for_label }}" class="form-label">{{ form.username.label }}</label>
               {{ form.username.errors }}
              {{ form.username }}
            </div>
            <div class="mb-3">
              <label for="{{ form.correo.id_for_label }}" class="form-label">{{ form.correo.label }}</label>
               {{ form.correo.errors }}
              {{ form.correo }}
            </div>
            <div class="mb-3">
              <label for="{{ form.telefono.id_for_label }}" class="form-label">{{ form.telefono.label }}</label>
               {{ form.telefono.errors }}
              {{ form.telefono }}
            </div>
            {# --- Campo Dirección añadido --- #}
            <div class="mb-3">
              <label for="{{ form.direccion.id_for_label }}" class="form-label">{{ form.direccion.label }}</label>
               {{ form.direccion.errors }}
              {{ form.direccion }}
            </div>
            <div class="mb-3">
              <label for="{{ form.password.id_for_label }}" class="form-label">{{ form.password.label }}</label>
               {{ form.password.errors }}
              {{ form.password }}
            </div>
             {# --- Campo Confirmar Contraseña añadido --- #}
            <div class="mb-3">
                <label for="{{ form.password2.id_for_label }}" class="form-label">{{ form.password2.label }}</label>
                {{ form.password2.errors }}
                {{ form.password2 }}
            </div>

            <div class="d-grid gap-2 mb-4">
              <button type="submit" class="btn btn-primary">Crear cuenta</button>
            </div>

          </form>
           <div class="text-center">
                <p>¿Ya tienes una cuenta? <a href="{% url 'iniciar_sesion' %}">Inicia sesión aquí</a></p>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}

<script>
    // --- Script para mostrar/ocultar campos de perfil ---
    function toggleUsuarioFields() {
      const tipoUsuarioSelect = document.getElementById('id_tipo_usuario');
      if (!tipoUsuarioSelect) return;
  
      const tipoUsuario = tipoUsuarioSelect.value;
      const personaFields = document.getElementById('persona-fields');
      const empresaFields = document.getElementById('empresa-fields');
  
      if (!personaFields || !empresaFields) return;
  
      const personaInputs = personaFields.querySelectorAll('input, select, textarea');
      const empresaInputs = empresaFields.querySelectorAll('input, select, textarea');
  
      if (tipoUsuario === 'persona') {
        personaFields.style.display = 'block';
        empresaFields.style.display = 'none';
        personaInputs.forEach(input => {
          if (input.name === 'nombres' || input.name === 'apellidos') {
            input.required = true;
          } else {
            input.required = false;
          }
        });
        empresaInputs.forEach(input => input.required = false);
  
      } else if (tipoUsuario === 'empresa') {
        personaFields.style.display = 'none';
        empresaFields.style.display = 'block';
        personaInputs.forEach(input => input.required = false);
        empresaInputs.forEach(input => {
          if (input.name === 'nombre_empresa') {
             input.required = true;
          } else {
             input.required = false;
          }
        });
      } else {
        personaFields.style.display = 'none';
        empresaFields.style.display = 'none';
        personaInputs.forEach(input => input.required = false);
        empresaInputs.forEach(input => input.required = false);
      }
    }
  
    // --- Script para formatear RUT ---
    function formatRut(rut) {
        // 1. Limpiar entrada: permite solo números y k/K
        let cleanRut = rut.replace(/[^0-9kK]/gi, '').toUpperCase();
        let body = '';
        let dv = '';
  
        // 2. Separar cuerpo y dígito verificador
        if (cleanRut.length > 1) {
            dv = cleanRut.slice(-1);
            body = cleanRut.slice(0, -1);
        } else {
            // Si solo hay un caracter, podría ser el DV (K) o parte del cuerpo
            // Lo tratamos como cuerpo por ahora, excepto si es K
             if (cleanRut !== 'K'){
                  body = cleanRut;
             } else {
                  dv = 'K'; // Tratar K sola como DV
             }
  
        }
  
        // 3. Limitar longitud del cuerpo (máx 8 dígitos)
        body = body.slice(0, 8);
  
         // 4. Si no hay cuerpo, no formatear (maneja el caso de solo DV 'K')
         if (body.length === 0) {
             return dv; // Devolver solo K si es lo único válido
         }
  
  
        // 5. Formatear con guión
        let formatted = body;
        if (dv !== '') {
            formatted += '-' + dv;
        }
  
        return formatted;
    }
  
    // --- Ejecutar al cargar y al cambiar ---
    document.addEventListener('DOMContentLoaded', function() {
      // Toggle inicial
      toggleUsuarioFields();
      const tipoUsuarioSelect = document.getElementById('id_tipo_usuario');
      if (tipoUsuarioSelect) {
          tipoUsuarioSelect.addEventListener('change', toggleUsuarioFields);
      }
  
      // Listener para formateo de RUT
      const rutInput = document.getElementById('id_username');
      if (rutInput) {
          rutInput.addEventListener('input', function (e) {
              const originalValue = e.target.value;
              const formattedValue = formatRut(originalValue);
  
              // Actualizar solo si el valor formateado es diferente
              // para evitar problemas con el cursor
              if (originalValue !== formattedValue) {
                   // Guardar posición del cursor
                   let start = e.target.selectionStart;
                   let end = e.target.selectionEnd;
                   let diff = formattedValue.length - originalValue.length;
  
                   e.target.value = formattedValue;
  
                   // Restaurar posición del cursor (aproximado)
                   e.target.setSelectionRange(start + diff, end + diff);
              }
          });
  
           // Formatear al perder foco (blur) por si pegan texto
           rutInput.addEventListener('blur', function(e) {
                e.target.value = formatRut(e.target.value);
           });
      }
    });
  </script>

{% endblock %}
